<!DOCTYPE html>
<html lang="en">
<head>
        <title>Django Game Backend Tutorial</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://olya-d.github.io/theme/css/main.css" type="text/css" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://olya-d.github.io/css/ie.css"/>
                <script src="http://olya-d.github.io/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://olya-d.github.io/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://olya-d.github.io">o </a></h1>
                <nav>
                    <a href="http://olya-d.github.io/category/misc.html">misc</a>&nbsp;
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="django-game-backend-tutorial.html" rel="bookmark"
           title="Permalink to Django Game Backend Tutorial">Django Game Backend Tutorial</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-12-15T00:00:00+01:00">
                Tue 15 December 2015
        </abbr>
</footer><!-- /.post-info -->      <div class="toc" id="">

<ul class="simple">
<li><a class="reference internal" href="#why-backend" id="id1">Why backend?</a></li>
<li><a class="reference internal" href="#starting-out" id="id2">Starting out</a><ul>
<li><a class="reference internal" href="#prerequisites" id="id3">Prerequisites</a></li>
<li><a class="reference internal" href="#steps" id="id4">Steps</a></li>
</ul>
</li>
<li><a class="reference internal" href="#api" id="id5">API</a></li>
<li><a class="reference internal" href="#background-and-scheduled-jobs" id="id6">Background and scheduled jobs</a></li>
<li><a class="reference internal" href="#finite-state-machine" id="id7">Finite state machine</a></li>
<li><a class="reference internal" href="#real-time-communication" id="id8">Real-time communication</a></li>
</ul>
</div>
      
<div class="section" id="why-backend">
<h2><a class="toc-backref" href="#id1">Why backend?</a></h2>
<ul class="simple">
<li>Provide dynamic content</li>
<li>Prevent cheating, especially in JavaScript based games</li>
<li>Store sensitive data</li>
<li>Collect data to provide game analytics</li>
<li>Synchronization among devices</li>
<li>Social component (leaderboards, communication between players)</li>
<li>Multiplayer</li>
</ul>
</div>
<div class="section" id="starting-out">
<h2><a class="toc-backref" href="#id2">Starting out</a></h2>
<div class="section" id="prerequisites">
<h3><a class="toc-backref" href="#id3">Prerequisites</a></h3>
<ol class="arabic simple">
<li><a class="reference external" href="http://python.org/">Python:</a> - programming language.</li>
<li><a class="reference external" href="https://pip.pypa.io/en/stable/">pip:</a> - Python package manager.</li>
<li><a class="reference external" href="http://virtualenv.readthedocs.org/en/latest/">virtualenv:</a> - tool to create isolated Python environments.</li>
</ol>
</div>
<div class="section" id="steps">
<h3><a class="toc-backref" href="#id4">Steps</a></h3>
<ol class="arabic simple">
<li>Create a Python environment: <tt class="docutils literal">mkvirtualenv game</tt></li>
<li>Install Django <tt class="docutils literal">pip install <span class="pre">Django==1.8.7</span></tt></li>
<li>Start Django project: <tt class="docutils literal"><span class="pre">django-admin.py</span> startproject game</tt></li>
<li><tt class="docutils literal">cd game</tt></li>
<li>Apply initial migrations to the database: <tt class="docutils literal">./manage.py migrate</tt></li>
</ol>
</div>
</div>
<div class="section" id="api">
<h2><a class="toc-backref" href="#id5">API</a></h2>
<p>We will use <a class="reference external" href="http://www.django-rest-framework.org/">Django REST framework</a> - a powerful and flexible toolkit for building Web APIs. Let's install it:</p>
<pre class="code bash literal-block">
<span class="nv">$ </span>pip install djangorestframework
</pre>
<p>And add to the <tt class="docutils literal">INSTALLED_APPS</tt> in <tt class="docutils literal">game/settings.py</tt>:</p>
<pre class="code python literal-block">
<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s">'rest_framework'</span><span class="p">,</span>
<span class="p">]</span>
</pre>
<p>Suppose, that in our game each player has an inventory filled with items with weight. We would like to have a simple API to fetch inventory of a particular user.</p>
<p>First, let's create a new app called <tt class="docutils literal">inventory</tt>: <tt class="docutils literal">./manage.py startapp inventory</tt>. Add <tt class="docutils literal">inventory</tt> to <tt class="docutils literal">INSTALLED_APPS</tt> as well.</p>
<p>The next step is to create Invenory and Item models, which will correspond to the tables in the database. Add the following code to <tt class="docutils literal">inventory/models.py</tt>:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.core.validators</span> <span class="kn">import</span> <span class="n">MinValueValidator</span>


<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">'Weight in kg'</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>


<span class="k">class</span> <span class="nc">Inventory</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Item</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s">'inventories'</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">"{}'s inventory"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</pre>
<p>Make and run migrations to add new tables to the database:</p>
<pre class="code bash literal-block">
<span class="nv">$ </span>./manage.py makemigrations
<span class="nv">$ </span>./manage.py migrate
</pre>
<p>Django comes with a handy admin dashboard. Let's our models to it - add these lines to <tt class="docutils literal">inventory/admin.py</tt>:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">Inventory</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">([</span><span class="n">Item</span><span class="p">,</span> <span class="n">Inventory</span><span class="p">])</span>
</pre>
<p>Let's create a superuser:</p>
<pre class="code bash literal-block">
<span class="nv">$ </span>./manage.py createsuperuser
</pre>
<p>Now if we run Django server, we will be able to login to the admin dashboard located at <tt class="docutils literal">localhost:8000/admin</tt>:</p>
<pre class="code bash literal-block">
<span class="nv">$ </span>./manage runserver
</pre>
<p>You can see Items and Inventories and you can add, change and delete records.</p>
<p>Now let's continue with our API. First, we define serializers for our models, which DRF will use to convert records to JSON. Then we add views, which will respond to API requests.</p>
<p>Create <tt class="docutils literal">serializers.py</tt> and add:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">Inventory</span>


<span class="k">class</span> <span class="nc">ItemSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Item</span>


<span class="k">class</span> <span class="nc">InventorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Inventory</span>
</pre>
<p>Add to <tt class="docutils literal">views.py</tt>:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">Inventory</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">ItemSerializer</span><span class="p">,</span> <span class="n">InventorySerializer</span>


<span class="k">class</span> <span class="nc">ItemViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'weight'</span><span class="p">)</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">ItemSerializer</span>


<span class="k">class</span> <span class="nc">InventoryViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Inventory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">InventorySerializer</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""
        Optionally restricts the returned purchases to a given user,
        by filtering against a `username` query parameter in the URL.
        """</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Inventory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'username'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user__username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queryset</span>
</pre>
<p>Finally, let's specify urls at which our API will be accessible. Modify <tt class="docutils literal">game/urls.py</tt> so it looks like this:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>

<span class="kn">from</span> <span class="nn">inventory.views</span> <span class="kn">import</span> <span class="n">ItemViewSet</span><span class="p">,</span> <span class="n">InventoryViewSet</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">DefaultRouter</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">r'items'</span><span class="p">,</span> <span class="n">ItemViewSet</span><span class="p">)</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">r'inventories'</span><span class="p">,</span> <span class="n">InventoryViewSet</span><span class="p">,</span> <span class="n">base_name</span><span class="o">=</span><span class="s">'inventories'</span><span class="p">)</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^api/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
<span class="p">]</span>
</pre>
<p>That's it! We can test our API:</p>
<pre class="code bash literal-block">
<span class="nv">$ </span>curl -H <span class="s1">'Accept: application/json; indent=4'</span> http://127.0.0.1:8000/api/items/ <span class="c"># Getting all items
</span>&gt; <span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">"id"</span>: 1,
        <span class="s2">"name"</span>: <span class="s2">"Guitar"</span>,
        <span class="s2">"weight"</span>: 2.0
    <span class="o">}</span>,
    <span class="o">{</span>
        <span class="s2">"id"</span>: 2,
        <span class="s2">"name"</span>: <span class="s2">"Piano"</span>,
        <span class="s2">"weight"</span>: 10.0
    <span class="o">}</span>
  <span class="o">]</span>
<span class="nv">$ </span>curl -H <span class="s1">'Accept: application/json; indent=4'</span> http://127.0.0.1:8000/api/inventories/?username<span class="o">=</span>admin
&gt; <span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">"id"</span>: 1,
        <span class="s2">"user"</span>: 1,
        <span class="s2">"items"</span>: <span class="o">[</span>
            1,
            2
        <span class="o">]</span>
    <span class="o">}</span>
  <span class="o">]</span>
</pre>
</div>
<div class="section" id="background-and-scheduled-jobs">
<h2><a class="toc-backref" href="#id6">Background and scheduled jobs</a></h2>
<p>We will use <a class="reference external" href="http://www.celeryproject.org/">Celery</a> - an asynchronous task queue/job queue based on distributed message passing. Celery is used to schedule work either periodically or just not blocking the request thread. Typical examples are:</p>
<ul class="simple">
<li>Long running computations</li>
<li>Periodic retrievel of data from external sources</li>
</ul>
<p>Our example will be very simple - let's give each player a gift in a form of a new special item every 10 seconds.</p>
<p>Celery requires a message transport to send and receive messages. In our case it will be <a class="reference external" href="http://www.rabbitmq.com/">RabbitMQ</a>, which should be installed on your machine.</p>
<p>Now let's install celery:</p>
<pre class="code bash literal-block">
<span class="nv">$ </span>pip install celery
</pre>
<p>Create new file <tt class="docutils literal">game/celery.py</tt> with the following content:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="c"># set the default Django settings module for the 'celery' program.</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">'DJANGO_SETTINGS_MODULE'</span><span class="p">,</span> <span class="s">'game.settings'</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>  <span class="c"># noqa</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'game'</span><span class="p">)</span>

<span class="c"># Using a string here means the worker will not have to</span>
<span class="c"># pickle the object when using Windows.</span>
<span class="n">app</span><span class="o">.</span><span class="n">config_from_object</span><span class="p">(</span><span class="s">'django.conf:settings'</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">autodiscover_tasks</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">)</span>
</pre>
<p>The next thing is to create our task in <tt class="docutils literal">inventory/tasks.py</tt>:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="kn">from</span> <span class="nn">game.celery</span> <span class="kn">import</span> <span class="n">app</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Item</span>


<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">give_gift</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">iterator</span><span class="p">():</span>
        <span class="n">item</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s">'Gift for {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">),</span> <span class="n">weight</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre>
<p>Normally, you would execute this task by calling <tt class="docutils literal">give_gift.delay()</tt>. That would put in the background. In our case, we want to use Celery beat, a scheduler, to make it a periodic task. All that's required is to add these lines to <tt class="docutils literal">game/settings.py</tt>:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="n">CELERYBEAT_SCHEDULE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'give-gift-every-10-seconds'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'task'</span><span class="p">:</span> <span class="s">'inventory.tasks.give_gift'</span><span class="p">,</span>
        <span class="s">'schedule'</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre>
<p>Now we only have to start rabbitmq, celery worker and celery beat:</p>
<pre class="code bash literal-block">
<span class="nv">$ </span>sudo rabbitmq-server
<span class="nv">$ </span>celery -A game beat
<span class="nv">$ </span>celery -A game worker
</pre>
<p>We can check results in Django shell (started by <tt class="docutils literal">./manage.py shell</tt>):</p>
<pre class="code python literal-block">
<span class="err">$</span> <span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="err">$</span> <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="err">$</span> <span class="n">u</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">Item</span><span class="p">:</span> <span class="n">Guitar</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Item</span><span class="p">:</span> <span class="n">Piano</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Item</span><span class="p">:</span> <span class="n">Gift</span> <span class="k">for</span> <span class="n">admin</span><span class="o">&gt;</span><span class="p">]</span>
<span class="err">$</span> <span class="n">u</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c"># after 10 seconds</span>
<span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">Item</span><span class="p">:</span> <span class="n">Guitar</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Item</span><span class="p">:</span> <span class="n">Piano</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Item</span><span class="p">:</span> <span class="n">Gift</span> <span class="k">for</span> <span class="n">admin</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Item</span><span class="p">:</span> <span class="n">Gift</span> <span class="k">for</span> <span class="n">admin</span><span class="o">&gt;</span><span class="p">]</span>
</pre>
</div>
<div class="section" id="finite-state-machine">
<h2><a class="toc-backref" href="#id7">Finite state machine</a></h2>
<p>This is not really related to Django, but I would like to show how easily Django model can have a finit state machine with <a class="reference external" href="https://github.com/kmmbvnr/django-fsm">django-fsm</a> package.</p>
<p>Let's create another app called <tt class="docutils literal">enemies</tt> and add the following code to <tt class="docutils literal">enemies/models.py</tt>:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django_fsm</span> <span class="kn">import</span> <span class="n">FSMIntegerField</span><span class="p">,</span> <span class="n">transition</span><span class="p">,</span> <span class="n">can_proceed</span>


<span class="k">class</span> <span class="nc">Monster</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">WANDERING</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">ATTACKING</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">LOOKING_FOR_AID</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">EVADING</span> <span class="o">=</span> <span class="mi">40</span>

    <span class="n">STATES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">WANDERING</span><span class="p">,</span> <span class="s">'wandering'</span><span class="p">),</span>
        <span class="p">(</span><span class="n">ATTACKING</span><span class="p">,</span> <span class="s">'attacking'</span><span class="p">),</span>
        <span class="p">(</span><span class="n">LOOKING_FOR_AID</span><span class="p">,</span> <span class="s">'looking_for_aid'</span><span class="p">),</span>
        <span class="p">(</span><span class="n">EVADING</span><span class="p">,</span> <span class="s">'evading'</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">FSMIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">WANDERING</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">STATES</span><span class="p">)</span>
    <span class="n">user_being_attacked</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">health_points</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">health_is_low</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">health_points</span> <span class="o">&lt;=</span> <span class="mi">5</span>

    <span class="nd">@transition</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="p">[</span><span class="n">WANDERING</span><span class="p">],</span>
                <span class="n">target</span><span class="o">=</span><span class="n">ATTACKING</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">attack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_being_attacked</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Attacking user'</span><span class="p">)</span>

    <span class="nd">@transition</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="p">[</span><span class="n">ATTACKING</span><span class="p">,</span> <span class="n">LOOKING_FOR_AID</span><span class="p">],</span>
                <span class="n">target</span><span class="o">=</span><span class="n">WANDERING</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wander</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_being_attacked</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Just wandering'</span><span class="p">)</span>

    <span class="nd">@transition</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="p">[</span><span class="n">ATTACKING</span><span class="p">],</span>
                <span class="n">target</span><span class="o">=</span><span class="n">EVADING</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">evade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@transition</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="p">[</span><span class="n">EVADING</span><span class="p">],</span>
                <span class="n">target</span><span class="o">=</span><span class="n">LOOKING_FOR_AID</span><span class="p">,</span>
                <span class="n">conditions</span><span class="o">=</span><span class="p">[</span><span class="n">health_is_low</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">look_for_aid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Looking for aid'</span><span class="p">)</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">Monster</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_save_callback</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">monster</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">'instance'</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">can_proceed</span><span class="p">(</span><span class="n">monster</span><span class="o">.</span><span class="n">look_for_aid</span><span class="p">):</span>
        <span class="n">monster</span><span class="o">.</span><span class="n">look_for_aid</span><span class="p">()</span>
        <span class="n">monster</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre>
<p>The FSM is taken from <a class="reference external" href="http://gamedevelopment.tutsplus.com/tutorials/finite-state-machines-theory-and-implementation--gamedev-11867">Finite-State Machines: Theory and Implementation</a>:</p>
<img alt="" src="https://cdn.tutsplus.com/gamedev/uploads/2013/10/fsm_enemy_brain.png"/>
<p>As you can see, for each transition we can define source, target and conditions. We use Django's signals to listen when model is saved and try to look for aid. If conditions are not met or there is not transisiton, <tt class="docutils literal">can_proceed</tt> will return <tt class="docutils literal">False</tt>.</p>
<p>Let's test in the shell:</p>
<pre class="code python literal-block">
<span class="err">$</span> <span class="kn">from</span> <span class="nn">enemies.models</span> <span class="kn">import</span> <span class="n">Monster</span>
<span class="err">$</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Monster</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
<span class="err">$</span> <span class="n">m</span><span class="o">.</span><span class="n">get_state_display</span><span class="p">()</span>
<span class="o">&gt;</span> <span class="s">'wandering'</span>
<span class="err">$</span> <span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="err">$</span> <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
<span class="err">$</span> <span class="n">m</span><span class="o">.</span><span class="n">attack</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">Attacking</span> <span class="n">user</span>
<span class="err">$</span> <span class="n">m</span><span class="o">.</span><span class="n">get_state_display</span><span class="p">()</span>
<span class="o">&gt;</span> <span class="s">'attacking'</span>
<span class="err">$</span> <span class="n">m</span><span class="o">.</span><span class="n">evade</span><span class="p">()</span>
<span class="err">$</span> <span class="n">m</span><span class="o">.</span><span class="n">get_state_display</span><span class="p">()</span>
<span class="o">&gt;</span> <span class="s">'evading'</span>
<span class="err">$</span> <span class="n">m</span><span class="o">.</span><span class="n">health_points</span> <span class="o">=</span> <span class="mi">2</span>
<span class="err">$</span> <span class="n">m</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="o">&gt;</span> <span class="n">Looking</span> <span class="k">for</span> <span class="n">aid</span>
</pre>
</div>
<div class="section" id="real-time-communication">
<h2><a class="toc-backref" href="#id8">Real-time communication</a></h2>
<p>Web frameworks as Django were not designed to handle real-time communication, put such functionality is more and more demanded.
You can find several stable popular solution in the world of Python - <a class="reference external" href="http://www.tornadoweb.org">Tornado</a>, a web framework and asynchronous networking library, <a class="reference external" href="https://twistedmatrix.com/trac/">Twisted</a>, an event-driven networking engine. Integration with Django can be problematic, but at least the code base can be shared.</p>
<p>Here we will take a look at one of the recent solution to this problem - <a class="reference external" href="http://swampdragon.net/">SwampDragon</a>, a real-time web framerowk built for Django with Tornado and Redis.</p>
<p>Install SwampDragon (<tt class="docutils literal">pip install swampdragon</tt>), create a new app called <tt class="docutils literal">players</tt> and add both <tt class="docutils literal">players</tt> and <tt class="docutils literal">swampdragon</tt> to <tt class="docutils literal">INSTALLED_APPS</tt>. Ammend <tt class="docutils literal">game/settings.py</tt>:</p>
<pre class="code python literal-block">
<span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
<span class="p">{</span>
    <span class="s">'BACKEND'</span><span class="p">:</span> <span class="s">'django.template.backends.django.DjangoTemplates'</span><span class="p">,</span>
    <span class="s">'DIRS'</span><span class="p">:</span> <span class="p">[</span><span class="s">'templates/'</span><span class="p">],</span>
    <span class="o">...</span>
<span class="p">}</span>

<span class="n">STATICFILES_DIRS</span> <span class="o">=</span> <span class="p">[</span><span class="s">'static/'</span><span class="p">]</span>

<span class="n">SWAMP_DRAGON_CONNECTION</span> <span class="o">=</span> <span class="p">(</span>
   <span class="s">'swampdragon.connections.sockjs_connection.DjangoSubscriberConnection'</span><span class="p">,</span>
   <span class="s">'/data'</span>
<span class="p">)</span>

<span class="n">DRAGON_URL</span> <span class="o">=</span> <span class="s">'http://localhost:9999/'</span>
</pre>
<p>Let's create a new model with <tt class="docutils literal">SelfPublishModel</tt> mixin:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">swampdragon.models</span> <span class="kn">import</span> <span class="n">SelfPublishModel</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">PlayerSerializer</span>


<span class="k">class</span> <span class="nc">Player</span><span class="p">(</span><span class="n">SelfPublishModel</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PlayerSerializer</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="n">position_x</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">position_y</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
</pre>
<p>And a serializer in <tt class="docutils literal">players/serializers.py</tt> (this is slightly inconvinient, since DRF also requires us to define serializers, but the work of integrating serializers from DRF is in progerss):</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">swampdragon.serializers.model_serializer</span> <span class="kn">import</span> <span class="n">ModelSerializer</span>


<span class="k">class</span> <span class="nc">PlayerSerializer</span><span class="p">(</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="s">'players.Player'</span>
        <span class="n">publish_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'position_x'</span><span class="p">,</span> <span class="s">'position_y'</span><span class="p">)</span>
        <span class="n">update_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">'position_x'</span><span class="p">,</span> <span class="s">'position_y'</span><span class="p">)</span>
</pre>
<p>Instead of views, SwampDragon uses routers:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">swampdragon</span> <span class="kn">import</span> <span class="n">route_handler</span>
<span class="kn">from</span> <span class="nn">swampdragon.route_handler</span> <span class="kn">import</span> <span class="n">ModelRouter</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Player</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">PlayerSerializer</span>


<span class="k">class</span> <span class="nc">PlayerRouter</span><span class="p">(</span><span class="n">ModelRouter</span><span class="p">):</span>
    <span class="n">route_name</span> <span class="o">=</span> <span class="s">'player'</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">PlayerSerializer</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Player</span>

    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">'id'</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_query_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>


<span class="n">route_handler</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">PlayerRouter</span><span class="p">)</span>
</pre>
<p>Now let's add templates. Create <tt class="docutils literal">templates</tt> directory and <tt class="docutils literal">index.html</tt> inside with the following content:</p>
<pre class="code html literal-block">
{% load static swampdragon_tags %}
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">ng-app=</span><span class="s">"GameApp"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

{% verbatim %}
<span class="nt">&lt;div</span> <span class="na">ng-controller=</span><span class="s">"PlayerCtrl"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;li</span> <span class="na">ng-repeat=</span><span class="s">"player in players"</span><span class="nt">&gt;</span>
      {{ player.position_x }}
      {{ player.position_y }}
      <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">ng-click=</span><span class="s">"moveRight(player)"</span><span class="nt">&gt;</span>
        Move right
      <span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">ng-click=</span><span class="s">"moveLeft(player)"</span><span class="nt">&gt;</span>
        Move Left
      <span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">ng-click=</span><span class="s">"moveUp(player)"</span><span class="nt">&gt;</span>
        Move Up
      <span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">ng-click=</span><span class="s">"moveDown(player)"</span><span class="nt">&gt;</span>
        Move Down
      <span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/div&gt;</span>
{% endverbatim %}

<span class="c">&lt;!-- AngularJS --&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"//ajax.googleapis.com/ajax/libs/angularjs/1.2.21/angular.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"//ajax.googleapis.com/ajax/libs/angularjs/1.2.21/angular-route.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

{% swampdragon_settings %}
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"{% static 'swampdragon/js/dist/swampdragon.min.js' %}"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"{% static 'swampdragon/js/dist/datamapper.js' %}"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"{% static 'swampdragon/js/angular/services.js' %}"</span><span class="nt">&gt;&lt;/script&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"{% static 'app.js' %}"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"{% static 'controllers.js' %}"</span><span class="nt">&gt;&lt;/script&gt;</span>

<span class="nt">&lt;/body&gt;</span>
</pre>
<p>Add a view, that will render this template to <tt class="docutils literal">game/urls.py</tt>:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">TemplateView</span>

<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>

<span class="kn">from</span> <span class="nn">inventory.views</span> <span class="kn">import</span> <span class="n">ItemViewSet</span><span class="p">,</span> <span class="n">InventoryViewSet</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">DefaultRouter</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">r'items'</span><span class="p">,</span> <span class="n">ItemViewSet</span><span class="p">)</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">r'inventories'</span><span class="p">,</span> <span class="n">InventoryViewSet</span><span class="p">)</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="n">TemplateView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="n">template_name</span><span class="o">=</span><span class="s">'index.html'</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s">'home'</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^api/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r'^admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
<span class="p">]</span>
</pre>
<p>Create <tt class="docutils literal">static</tt> directory for JavaScript files. First, let's define our app in <tt class="docutils literal">app.js</tt>:</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">GameApp</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'GameApp'</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">'SwampDragonServices'</span><span class="p">,</span>
    <span class="s1">'PlayerControllers'</span>
<span class="p">]);</span>
</pre>
<p>and our controller in <tt class="docutils literal">controllers.js</tt>:</p>
<pre class="code javascript literal-block">
<span class="kd">var</span> <span class="nx">PlayerControllers</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'PlayerControllers'</span><span class="p">,</span> <span class="p">[]);</span>

<span class="nx">PlayerControllers</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">'PlayerCtrl'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'$scope'</span><span class="p">,</span> <span class="s1">'$dragon'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$dragon</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">players</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="s1">'players'</span><span class="p">;</span>

    <span class="nx">$dragon</span><span class="p">.</span><span class="nx">onReady</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$dragon</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s1">'player'</span><span class="p">,</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">channel</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$scope</span><span class="p">.</span><span class="nx">dataMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataMapper</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">$dragon</span><span class="p">.</span><span class="nx">getList</span><span class="p">(</span><span class="s1">'player'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$scope</span><span class="p">.</span><span class="nx">players</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">$dragon</span><span class="p">.</span><span class="nx">onChannelMessage</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">channels</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">indexOf</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">channels</span><span class="p">,</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">channel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$scope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">$scope</span><span class="p">.</span><span class="nx">dataMapper</span><span class="p">.</span><span class="nx">mapData</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">players</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="kd">var</span> <span class="nx">move</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">position_x</span> <span class="o">+=</span> <span class="nx">dx</span><span class="p">;</span>
        <span class="nx">player</span><span class="p">.</span><span class="nx">position_y</span> <span class="o">+=</span> <span class="nx">dy</span><span class="p">;</span>
        <span class="nx">$dragon</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s1">'player'</span><span class="p">,</span> <span class="nx">player</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="nx">$scope</span><span class="p">.</span><span class="nx">moveRight</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">move</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">moveLeft</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">move</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">moveUp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">move</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">moveDown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">move</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">};</span>
<span class="p">}]);</span>
</pre>
<p>To make real-time communication work we need an additional server running. Download <a class="reference external" href="https://raw.githubusercontent.com/jonashagstedt/swampdragon/master/swampdragon/app_templates/server.py">server.py</a> from SwampDragon repository and save it next to <tt class="docutils literal">manage.py</tt>.</p>
<p>Now if you run both <tt class="docutils literal">./manage.py runserver</tt> and <tt class="docutils literal">python server.py</tt> you can test our app in the browser.</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                     Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>. Theme is using <a href="http://github.com/getpelican/pelican-themes" target="_blank">cebong</a>.
                </address><!-- /#about -->

        </footer><!-- /#contentinfo -->

</body>
</html>